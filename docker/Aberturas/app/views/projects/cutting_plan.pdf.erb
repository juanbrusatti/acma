<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }
    
    .plate-container {
      page-break-after: always;
      margin-bottom: 40px;
    }
    
    .plate-info {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }
    
    .plate-info h2 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .plate-info p {
      margin: 5px 0;
      font-size: 12px;
    }
    
    .cutting-diagram {
      border: 1px solid #000;
      position: relative;
      margin: 20px auto;
      background-color: #f8f8f8;
      box-sizing: border-box;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    
    .cut-piece {
      position: absolute;
      border: 1px solid #222;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: normal;
      text-align: center;
      padding: 2px;
      margin: 0;
      box-sizing: border-box;
      box-shadow: 0 0 0 1px #fff;
    }
    
    .scrap-piece {
      position: absolute;
      border: 2px solid #ff6b6b;
      background-color: rgba(255, 107, 107, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      text-align: center;
      padding: 2px;
      margin: 0;
      box-sizing: border-box;
      color: #d63031;
    }
    
    .scrap-piece .dimensions {
      font-size: 7px;
      line-height: 1.1;
      padding: 1px;
      word-break: break-all;
      overflow: hidden;
      color: #d63031;
      background-color: rgba(255,255,255,0.9);
      border-radius: 2px;
      font-weight: bold;
    }
    
    .cut-piece .dimensions {
      font-size: 8px;
      line-height: 1.2;
      padding: 2px;
      word-break: break-all;
      overflow: hidden;
      color: #333;
      background-color: rgba(255,255,255,0.7);
      border-radius: 2px;
    }
    
    
    .legend {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
    }
    
    .legend-item {
      display: inline-block;
      margin-right: 20px;
      margin-bottom: 5px;
    }
    
    .legend-color {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
      vertical-align: middle;
      margin-right: 5px;
    }
    
    .cuts-list {
      margin-top: 20px;
    }
    
    .cuts-list table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    .cuts-list th,
    .cuts-list td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    
    .cuts-list th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    
    .summary {
      margin-top: 20px;
      padding: 15px;
      background-color: #e3f2fd;
      border: 2px solid #2196F3;
      border-radius: 5px;
    }
    
    .summary h3 {
      margin-top: 0;
      color: #1976D2;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Plan de Corte Optimizado</h1>
    <p><strong>Proyecto:</strong> <%= project.name %></p>
    <p><strong>Fecha:</strong> <%= Time.current.strftime('%d/%m/%Y %H:%M') %></p>
    <p><strong>Total de Planchas:</strong> <%= cutting_plans.length %></p>
  </div>

  <% cutting_plans.each_with_index do |plan, index| %>
    <div class="plate-container">
      <div class="plate-info">
        <h2>Plancha <%= index + 1 %> - <%= plan[:source_ref] %></h2>
        <p><strong>Tipo:</strong> <%= plan[:glass_type] %> | <strong>Espesor:</strong> <%= plan[:thickness] %> | <strong>Color:</strong> <%= plan[:color] %></p>
        <p><strong>Dimensiones:</strong> <%= plan[:plate_width].to_i %> x <%= plan[:plate_height].to_i %> mm</p>
            <p><strong>Cantidad de cortes:</strong> <%= plan[:cuts].length %></p>
      </div>

      <%
        # Calcular escala para que quepa en la página
        max_width = 700 # px en el PDF
        max_height = 500
        
        scale_x = max_width.to_f / plan[:plate_width]
        scale_y = max_height.to_f / plan[:plate_height]
        scale = [scale_x, scale_y].min
        
        diagram_width = (plan[:plate_width] * scale).to_i
        diagram_height = (plan[:plate_height] * scale).to_i
      %>

      <div class="cutting-diagram" style="width: <%= diagram_width %>px; height: <%= diagram_height %>px;">
        <!-- Dibujar cortes -->
        <% plan[:cuts].each do |cut| %>
          <%
            cut_x = (cut[:x] * scale).to_i
            cut_y = (cut[:y] * scale).to_i
            cut_width = (cut[:width] * scale).to_i
            cut_height = (cut[:height] * scale).to_i
          %>
          <div class="cut-piece" style="left: <%= cut_x %>px; top: <%= cut_y %>px; width: <%= cut_width %>px; height: <%= cut_height %>px;">
            <div class="dimensions">
              <%= cut[:id] %><br>
              <%= cut[:width].to_i %> x <%= cut[:height].to_i %>
              <% if cut[:rotated] %>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Dibujar sobrantes -->
        <% if plan[:scraps] && plan[:scraps].any? %>
          <% plan[:scraps].each do |scrap| %>
            <%
              scrap_x = (scrap[:x] * scale).to_i
              scrap_y = (scrap[:y] * scale).to_i
              scrap_width = (scrap[:width] * scale).to_i
              scrap_height = (scrap[:height] * scale).to_i
            %>
            <div class="scrap-piece" style="left: <%= scrap_x %>px; top: <%= scrap_y %>px; width: <%= scrap_width %>px; height: <%= scrap_height %>px;">
              <div class="dimensions">
                SOBRANTE<br>
                <%= scrap[:width].to_i %> x <%= scrap[:height].to_i %>
              </div>
            </div>
          <% end %>
        <% end %>

      </div>
          Corte de vidrio
        </div>
      </div>

      <!-- Lista de cortes en esta plancha -->
      <div class="cuts-list">
        <h3>Detalle de Cortes</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Ancho (mm)</th>
              <th>Alto (mm)</th>
              <th>Posición X</th>
              <th>Posición Y</th>
              <th>Rotado</th>
            </tr>
          </thead>
          <tbody>
            <% plan[:cuts].each do |cut| %>
              <tr>
                <td><%= cut[:id] %></td>
                <td><%= cut[:width].to_i %></td>
                <td><%= cut[:height].to_i %></td>
                <td><%= cut[:x].to_i %></td>
                <td><%= cut[:y].to_i %></td>
                <td><%= cut[:rotated] ? 'Sí' : 'No' %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Información de sobrantes -->
      <% if plan[:scraps] && plan[:scraps].any? %>
        <div class="cuts-list">
          <h3>Sobrantes Generados</h3>
          <table>
            <thead>
              <tr>
                <th>Dimensiones</th>
                <th>Posición X</th>
                <th>Posición Y</th>
                <th>Reutilizable</th>
                <th>Área (m²)</th>
              </tr>
            </thead>
            <tbody>
              <% plan[:scraps].each do |scrap| %>
                <tr>
                  <td><%= scrap[:width].to_i %> x <%= scrap[:height].to_i %></td>
                  <td><%= scrap[:x].to_i %></td>
                  <td><%= scrap[:y].to_i %></td>
                  <td><%= scrap[:reusable] ? 'Sí' : 'No' %></td>
                  <td><%= sprintf('%.4f', (scrap[:width] * scrap[:height]) / 1_000_000.0) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>

      <!-- Orden de cortes -->
      <% if plan[:cutting_order] && plan[:cutting_order].any? %>
        <div class="cuts-list">
          <h3>Orden de Cortes</h3>
          <table>
            <thead>
              <tr>
                <th>Orden</th>
                <th>Color</th>
                <th>Tipo</th>
                <th>Posición</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              <% plan[:cutting_order].each do |step| %>
                <tr>
                  <td><%= step[:order] %></td>
                  <td style="text-transform: capitalize; font-weight: bold;"><%= step[:color] %></td>
                  <td><%= step[:type] == 'horizontal' ? 'Horizontal' : 'Vertical' %></td>
                  <td><%= step[:position].to_i %> mm</td>
                  <td><%= step[:description] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>

    </div>
  <% end %>

  <!-- Resumen general -->
  <div class="summary" style="page-break-before: always;">
    <h3>Resumen General del Proyecto</h3>
    <% 
      total_cuts = cutting_plans.sum { |p| p[:cuts].length }
      plates_new = cutting_plans.count { |p| p[:source_type] == 'plate' }
      total_scraps = cutting_plans.sum { |p| p[:scraps]&.length || 0 }
      reusable_scraps = cutting_plans.sum { |p| p[:scraps]&.count { |s| s[:reusable] } || 0 }
    %>
    
    <p><strong>Total de cortes:</strong> <%= total_cuts %></p>
    <p><strong>Planchas utilizadas:</strong> <%= cutting_plans.length %></p>
    <p><strong>Planchas nuevas utilizadas:</strong> <%= plates_new %></p>
    <p><strong>Total de sobrantes generados:</strong> <%= total_scraps %></p>
    <p><strong>Sobrantes reutilizables:</strong> <%= reusable_scraps %></p>
    
    <hr style="margin: 20px 0;">
    
    <h4>Eficiencia de corte</h4>
    <% 
      total_plate_area = cutting_plans.sum { |p| (p[:plate_width] * p[:plate_height]) / 1_000_000.0 }
      total_cut_area = cutting_plans.sum { |p| p[:cuts].sum { |c| (c[:width] * c[:height]) / 1_000_000.0 } }
      total_scrap_area = cutting_plans.sum { |p| (p[:scraps] || []).sum { |s| (s[:width] * s[:height]) / 1_000_000.0 } }
      efficiency = total_plate_area > 0 ? (total_cut_area / total_plate_area * 100) : 0
    %>
    <p><strong>Área total de planchas:</strong> <%= sprintf('%.2f', total_plate_area) %> m²</p>
    <p><strong>Área total de cortes:</strong> <%= sprintf('%.2f', total_cut_area) %> m²</p>
    <p><strong>Área total de sobrantes:</strong> <%= sprintf('%.2f', total_scrap_area) %> m²</p>
    <p><strong>Eficiencia:</strong> <%= sprintf('%.1f', efficiency) %>%</p>
    
    <hr style="margin: 20px 0;">
    
    <h4>Leyenda</h4>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #fff; border: 1px solid #222;"></div>
        <span>Cortes de vidrio</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(255, 107, 107, 0.1); border: 2px solid #ff6b6b;"></div>
        <span>Sobrantes</span>
      </div>
    </div>
  </div>
</body>
</html>
