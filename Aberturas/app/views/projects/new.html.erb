<%# Title for the page #%>
<% content_for :title, "Nuevo proyecto" %>

<div class="w-full p-4 md:p-8">
  <h1 class="text-lg font-semibold mb-3">Generar proyecto</h1>

  <%= form_with(model: @project, local: true) do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Client Information Section -->
      <div class="bg-white rounded-md border border-gray-200 shadow-sm p-4">
        <h2 class="text-base font-semibold mb-2">Datos del Cliente</h2>
        <div class="space-y-2">
          <div>
            <%= f.label :name, "Nombre del Cliente" %>
            <%= f.text_field :name, class: "w-full border rounded px-2 py-1 text-sm" %>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <%= f.label :phone, "Teléfono" %>
              <%= f.telephone_field :phone, class: "w-full border rounded px-2 py-1 text-sm" %>
            </div>
            <div>
              <%= f.label :address, "Domicilio" %>
              <%= f.text_field :address, class: "w-full border rounded px-2 py-1 text-sm" %>
            </div>
          </div>
          <div>
            <%= f.label :description, "Descripción del proyecto" %>
            <%= f.text_area :description, rows: 3, class: "w-full border rounded px-2 py-1 text-sm" %>
          </div>
          <div>
            <%= f.label :delivery_date, "Fecha de entrega estimada" %>
            <%= f.date_field :delivery_date, class: "w-full border rounded px-2 py-1 text-sm" %>
          </div>
        </div>
      </div>

      <!-- Summary and Actions Section -->
      <div class="bg-white rounded-md border border-gray-200 shadow-sm p-4 flex flex-col justify-between">
        <div>
          <h2 class="text-base font-semibold mb-2">Resumen y acciones</h2>
          <div class="flex justify-between">
            <span>Subtotal</span>
            <span>$<%= number_with_precision(@project.try(:subtotal) || 0, precision: 2) %></span>
          </div>
          <div class="flex justify-between">
            <span>IVA (21%)</span>
            <span>$<%= number_with_precision(@project.try(:iva) || 0, precision: 2) %></span>
          </div>
          <hr class="my-2" />
          <div class="flex justify-between font-bold">
            <span>Total estimado</span>
            <span>$<%= number_with_precision(@project.try(:total) || 0, precision: 2) %></span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
          <%= f.submit "Guardar como presupuesto", class: "w-full bg-black text-white rounded px-2 py-2 text-sm" %>
          <button type="button" class="w-full border border-gray-300 rounded px-2 py-2 text-sm">Optimizar</button>
          <button type="button" class="w-full border border-gray-300 rounded px-2 py-2 text-sm">Guardar PDF</button>
          <%= link_to "Volver a proyectos", projects_path, class: "w-full border border-gray-300 rounded px-2 py-2 text-center text-sm" %>
        </div>
      </div>
    </div>

    <!-- Simple Glass Cuttings Table Section -->
    <div class="bg-white rounded-md border border-gray-200 shadow-sm p-4 mt-7">
      <h2 class="text-base font-semibold mb-4">Vidrios simples</h2>

      <!-- Container for dynamic glasscutting fields -->
      <div id="glasscuttings-wrapper">
        <%= f.fields_for :glasscuttings do |gc| %>
          <!-- Glasscutting form row with 8 columns for better layout -->
          <div class="grid grid-cols-8 gap-4 mb-4 glasscutting-fields">
            <div><%= gc.label :glass_type, "Tipo de vidrio" %> <%= gc.text_field :glass_type, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= gc.label :thickness, "Grosor" %> <%= gc.text_field :thickness, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= gc.label :height, "Alto (mm)" %> <%= gc.number_field :height, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= gc.label :width, "Ancho (mm)" %> <%= gc.number_field :width, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= gc.label :color, "Color" %> <%= gc.text_field :color, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= gc.label :location, "Ubicación" %> <%= gc.text_field :location, class: "w-full border rounded px-2 py-1" %></div>
          </div>
        <% end %>
      </div>

      <!-- Button to add new glasscutting fields -->
      <button type="button" id="add-glasscutting" class="mt-4 bg-black text-white px-4 py-2 rounded">Agregar vidrio simple</button>
    </div>

    <!-- DVH (Double Glazing) Table Section -->
    <div class="bg-white rounded-md border border-gray-200 shadow-sm p-4 mt-7">
      <h2 class="text-base font-semibold mb-4">DVH</h2>

      <!-- Container for dynamic DVH fields -->
      <div id="dvhs-wrapper">
        <%= f.fields_for :dvhs do |dvh| %>
          <!-- DVH form row with improved labels -->
          <div class="grid grid-cols-7 gap-4 mb-4 dvh-fields">
            <div><%= dvh.label :innertube, "Camara" %> <%= dvh.text_field :innertube, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= dvh.label :location, "Ubicación" %> <%= dvh.text_field :location, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= dvh.label :height, "Alto (mm)" %> <%= dvh.number_field :height, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= dvh.label :width, "Ancho (mm)" %> <%= dvh.number_field :width, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= dvh.label :glasscutting1_type, "Tipo vidrio 1" %> <%= dvh.text_field :glasscutting1_type, class: "w-full border rounded px-2 py-1" %></div>
            <div><%= dvh.label :glasscutting2_type, "Tipo vidrio 2" %> <%= dvh.text_field :glasscutting2_type, class: "w-full border rounded px-2 py-1" %></div>
          </div>
        <% end %>
      </div>

      <!-- Button to add new DVH fields -->
      <button type="button" id="add-dvh" class="mt-4 bg-black text-white px-4 py-2 rounded">Agregar DVH</button>
    </div>

  <% end %>
</div>

<!-- Hidden template for cloning glasscutting fields -->
<template id="glasscutting-template">
  <!-- Template for new glasscutting row with 8 columns and action buttons -->
  <div class="grid grid-cols-8 gap-4 mb-4 glasscutting-fields">
    <div><label>Tipo</label><input name="project[glasscuttings_attributes][][glass_type]" class="w-full border rounded px-2 py-1"></div>
    <div><label>Grosor</label><input name="project[glasscuttings_attributes][][thickness]" class="w-full border rounded px-2 py-1"></div>
    <div><label>Alto</label><input type="number" name="project[glasscuttings_attributes][][height]" class="w-full border rounded px-2 py-1"></div>
    <div><label>Ancho</label><input type="number" name="project[glasscuttings_attributes][][width]" class="w-full border rounded px-2 py-1"></div>
    <div><label>Color</label><input name="project[glasscuttings_attributes][][color]" class="w-full border rounded px-2 py-1"></div>
    <div><label>Ubicación</label><input name="project[glasscuttings_attributes][][location]" class="w-full border rounded px-2 py-1"></div>
    <!-- Action buttons spanning 2 columns -->
    <div class="actions space-x-2 mt-2 col-span-2">
      <button type="button" class="confirm-glass bg-green-600 text-white px-3 py-1 rounded mt-4">Confirmar</button>
    </div>
  </div>
</template>

<!-- Hidden template for cloning DVH fields -->
<template id="dvh-template">
  <div class="border border-gray-300 rounded p-4 mb-4 dvh-fields space-y-4">

    <!-- Row 1: Basic DVH information -->
    <div class="grid grid-cols-5 gap-4">
      <div>
        <label>Cámara</label>
        <input name="project[dvhs_attributes][][innertube]" class="w-full border rounded px-2 py-1" />
      </div>
      <div>
        <label>Ubicación</label>
        <input name="project[dvhs_attributes][][location]" class="w-full border rounded px-2 py-1" />
      </div>
      <div>
        <label>Ancho</label>
        <input type="number" name="project[dvhs_attributes][][width]" class="w-full border rounded px-2 py-1" />
      </div>
      <div>
        <label>Alto</label>
        <input type="number" name="project[dvhs_attributes][][height]" class="w-full border rounded px-2 py-1" />
      </div>
    </div>

    <!-- Row 2: Glass 1 specifications -->
    <div>
      <h3 class="font-semibold text-sm mb-2">Cristal 1</h3>
      <div class="grid grid-cols-5 gap-4">
        <div>
          <label>Tipo de vidrio</label>
          <input name="project[dvhs_attributes][][glasscutting1_type]" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label>Grosor</label>
          <input name="project[dvhs_attributes][][glasscutting1_thickness]" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label>Color</label>
          <input name="project[dvhs_attributes][][glasscutting1_color]" class="w-full border rounded px-2 py-1" />
        </div>
      </div>
    </div>

    <!-- Row 3: Glass 2 specifications -->
    <div>
      <h3 class="font-semibold text-sm mb-2">Cristal 2</h3>
      <div class="grid grid-cols-5 gap-4">
        <div>
          <label>Tipo de vidrio</label>
          <input name="project[dvhs_attributes][][glasscutting2_type]" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label>Grosor</label>
          <input name="project[dvhs_attributes][][glasscutting2_thickness]" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label>Color</label>
          <input name="project[dvhs_attributes][][glasscutting2_color]" class="w-full border rounded px-2 py-1" />
        </div>
      </div>
    </div>

  </div>
</template>

<!-- JavaScript for dynamic field addition -->
<script>
  // Add event listener for adding new glasscutting fields
  document.getElementById('add-glasscutting').addEventListener('click', () => {
    const template = document.getElementById('glasscutting-template').content.cloneNode(true);
    document.getElementById('glasscuttings-wrapper').appendChild(template);
  });

  // Add event listener for adding new DVH fields
  document.getElementById('add-dvh').addEventListener('click', () => {
    const template = document.getElementById('dvh-template').content.cloneNode(true);
    document.getElementById('dvhs-wrapper').appendChild(template);
  });
</script>

<!-- JavaScript for glasscutting confirmation and deletion functionality -->
<script>
  // Event delegation for confirm and delete buttons
  document.addEventListener("click", function (e) {
    // Handle confirm button click - locks the fields and replaces with delete button
    if (e.target.classList.contains("confirm-glass")) {
      const container = e.target.closest(".glasscutting-fields");
      const inputs = container.querySelectorAll("input");

      // Disable all input fields to lock the values
      inputs.forEach(input => input.setAttribute("readonly", true));

      // Replace confirm button with delete button
      const confirmButton = e.target;
      const deleteButton = document.createElement("button");
      deleteButton.type = "button";
      deleteButton.textContent = "Eliminar";
      deleteButton.className = "delete-glass bg-red-500 text-white px-3 py-1 rounded mt-4";

      confirmButton.replaceWith(deleteButton);
    }

    // Handle delete button click - removes the entire glasscutting row
    if (e.target.classList.contains("delete-glass")) {
      const container = e.target.closest(".glasscutting-fields");
      container.remove();
    }
  });
</script>
