<!-- DVH table section -->
<div class="bg-white rounded-md border border-gray-200 shadow-sm p-4 mt-7">
    <h2 class="text-base font-semibold mb-4">DVH</h2>

    <div id="dvhs-table-container">
      <% if @project.persisted? && @project.dvhs.any? %>
        <table class="min-w-full text-xs text-gray-700 border">
          <thead>
            <tr class='bg-gray-50 text-gray-500'>
              <th class='px-4 py-2 text-center'>TIPOLOGIA</th>
              <th class='px-6 py-2 text-center'>CÁMARA</th>
              <th class='px-4 py-2 text-center'>ANCHO</th>
              <th class='px-4 py-2 text-center'>ALTO</th>
              <th class='px-4 py-2 text-center'>CRISTAL 1</th>
              <th class='px-4 py-2 text-center'>CRISTAL 2</th>
              <th class='px-4 py-2 text-center'>PRECIO</th>
              <th class='px-4 py-2 text-center'>ACCIÓN</th>
            </tr>
          </thead>
          <tbody id="dvhs-table-body">
            <% @project.dvhs.each_with_index do |dvh, index| %>
              <tr class="divide-x divide-gray-200" data-id="<%= dvh.id %>">
                <td class="px-4 py-2 text-center"><%= dvh.typology %></td>
                <td class="px-6 py-2 text-center"><%= dvh.innertube %> mm</td>
                <td class="px-4 py-2 text-center"><%= dvh.width %> mm</td>
                <td class="px-4 py-2 text-center"><%= dvh.height %> mm</td>
                <td class="px-4 py-2 text-center">
                  <%= dvh.glasscutting1_type %> <%= dvh.glasscutting1_thickness %>mm <%= dvh.glasscutting1_color %>
                </td>
                <td class="px-4 py-2 text-center">
                  <%= dvh.glasscutting2_type.present? ? "#{dvh.glasscutting2_type} #{dvh.glasscutting2_thickness}mm #{dvh.glasscutting2_color}" : 'N/A' %>
                </td>
                <td class="px-4 py-2 text-center">$<%= number_with_precision(dvh.price, precision: 2) %></td>
                <td class="px-4 py-2 text-center">
                  <button type="button" class="text-red-600 hover:text-red-800" 
                          onclick="deleteDvh(this);">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][id]", dvh.id, id: "dvh_#{dvh.id}" %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][innertube]", dvh.innertube %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][width]", dvh.width %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][height]", dvh.height %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][typology]", dvh.typology %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting1_type]", dvh.glasscutting1_type %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting1_thickness]", dvh.glasscutting1_thickness %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting1_color]", dvh.glasscutting1_color %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting2_type]", dvh.glasscutting2_type %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting2_thickness]", dvh.glasscutting2_thickness %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][glasscutting2_color]", dvh.glasscutting2_color %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][price]", dvh.price %>
              <%= hidden_field_tag "project[dvhs_attributes][#{index}][_destroy]", "0" %>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </div>

    <!-- Container for hidden form inputs of confirmed DVH entries -->
    <div id="dvhs-hidden">
      <% if @project.persisted? %>
        <% @project.dvhs.each_with_index do |dvh, index| %>
          <%= hidden_field_tag "project[dvhs_attributes][#{index}][id]", dvh.id, id: "dvh_#{dvh.id}" %>
        <% end %>
      <% end %>
    </div>

    <!-- Container for dynamically generated DVH entry forms -->
    <div id="dvhs-wrapper">
    </div>

    <!-- Button to trigger creation of new DVH entry form -->
    <div class="mt-4">
      <%= button_tag "Agregar DVH", type: "button", id: "add-dvh", class: "bg-black text-white px-4 py-2 rounded hover:bg-gray-800 transition-colors" %>
    </div>
</div>

<script>
  // This script will run when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    // If there are existing DVHs, hide the empty state
    const dvhsTable = document.querySelector('#dvhs-table-container table');
    if (dvhsTable) {
      // Table is already rendered with server-side data
      return;
    }
    
    // If no DVHs, show the empty state
    const container = document.getElementById('dvhs-table-container');
    if (container) {
      container.innerHTML = `
        <div class="text-center py-4 text-gray-500">
          No hay DVHs cargados. Agrega uno para comenzar.
        </div>
      ` + container.innerHTML;
    }
  });
  
  // Function to delete a DVH
  function deleteDvh(button) {
    const row = button.closest('tr');
    const id = row.dataset.id;
    const hiddenInput = document.getElementById(`dvh_${id}`);
    
    if (hiddenInput) {
      // Mark for destruction instead of removing, in case it's an existing record
      hiddenInput.value = '';
      const destroyInput = document.createElement('input');
      destroyInput.type = 'hidden';
      destroyInput.name = `project[dvhs_attributes][${id}][_destroy]`;
      destroyInput.value = '1';
      hiddenInput.parentNode.appendChild(destroyInput);
    }
    
    row.remove();
    
    // If no more DVHs, show the empty state
    const tableBody = document.getElementById('dvhs-table-body');
    if (tableBody && tableBody.children.length === 0) {
      const container = document.getElementById('dvhs-table-container');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            No hay DVHs cargados. Agrega uno para comenzar.
          </div>
        ` + container.innerHTML;
      }
    }
  }
</script>